@model TasraPostaManager.Models.SettingsViewModel
@using Microsoft.AspNetCore.Mvc.ViewFeatures
@using TasraPostaManager.Models

@{
    var labelSettingsViewData = new ViewDataDictionary(ViewData);
    labelSettingsViewData.TemplateInfo.HtmlFieldPrefix = "LabelSettingsV2";

    ViewData["Title"] = "Ayarlar";
    var label = Model.LabelSettingsV2 ?? new LabelSettings();
}

@section Styles {
    <link href="~/css/settings.css" rel="stylesheet" />
}

@* ══════════════════════════════════
   PAGE HEADER
   ══════════════════════════════════ *@
<div class="settings-header">
    <div class="settings-title-wrapper">
        <div class="settings-icon-box">
            <i class="fas fa-cogs"></i>
        </div>
        <div>
            <h1 class="settings-title">Uygulama Ayarları</h1>
            <p class="settings-subtitle">PDF çıktı, gönderen bilgisi, barkod ve etiket yapılandırmaları</p>
        </div>
    </div>
</div>

<div id="alertPlaceholder"></div>

@* ── TempData mesajları ── *@
@if (TempData["Success"] is string successMessage && !string.IsNullOrWhiteSpace(successMessage))
{
    <div class="alert alert-success alert-dismissible fade show settings-alert" role="alert">
        <i class="fas fa-check-circle me-2"></i>@Html.Raw(successMessage)
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}
@if (TempData["Error"] is string errorMessage && !string.IsNullOrWhiteSpace(errorMessage))
{
    <div class="alert alert-danger alert-dismissible fade show settings-alert" role="alert">
        <i class="fas fa-exclamation-circle me-2"></i>@Html.Raw(errorMessage)
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}
@if (!string.IsNullOrWhiteSpace(Model.Message))
{
    <div class="alert @(Model.SettingsSaved ? "alert-success" : "alert-warning") alert-dismissible fade show settings-alert" role="alert">
        @Html.Raw(Model.Message)
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

<form asp-action="Index" asp-controller="Settings" method="post" class="needs-validation" novalidate id="settingsForm">
    @Html.AntiForgeryToken()

    @* ══════════════════════════════════════════════════════════
       SATIR 1 — iki büyük kart: Barkod Ayarları | Etiket Ayarları
       ══════════════════════════════════════════════════════════ *@
    <div class="row g-4 mb-4">
        @* ── SOL: Barkod Ayarları ── *@
        <div class="col-lg-6">
            <div class="settings-card h-100">
                <div class="settings-card-header">
                    <div class="settings-card-icon icon-secondary">
                        <i class="fas fa-barcode"></i>
                    </div>
                    <div>
                        <h5 class="settings-card-title">Barkod Ayarları</h5>
                        <p class="settings-card-desc">Barkod modu, numaralandırma ve havuz import/export.</p>
                    </div>
                </div>
                <div class="settings-card-body">
                    @* Mod ve Eşik *@
                    <div class="row g-3 mb-3">
                        <div class="col-md-6">
                            <label asp-for="DefaultBarcodeMode" class="settings-label">Barkod Modu</label>
                            <select asp-for="DefaultBarcodeMode" class="form-select settings-input">
                                <option value="Legacy">Legacy (Mevcut Üretim)</option>
                                <option value="Pool">Pool (Havuzdan Claim)</option>
                            </select>
                            <small class="settings-help">Pool: barkodlar BarcodePoolItems'den claim edilir.</small>
                        </div>
                        <div class="col-md-6">
                            <label asp-for="BarcodePoolLowThreshold" class="settings-label">Düşük Havuz Eşiği</label>
                            <input asp-for="BarcodePoolLowThreshold" class="form-control settings-input" type="number" min="0" />
                            <small class="settings-help">Bu eşikten azsa uyarı gösterilir.</small>
                        </div>
                    </div>

                    @* İçe Aktar *@
                    <div class="settings-section">
                        <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
                            <div>
                                <div class="settings-section-title">
                                    <i class="fas fa-file-excel me-1" style="color:var(--color-success)"></i>Barkod İçe Aktar
                                </div>
                                <div class="settings-section-desc">PTT .xlsx dosyasından havuza aktar</div>
                            </div>
                            <div class="d-flex align-items-center gap-2">
                                <input form="barcodePoolImportForm" type="file" name="file" accept=".xlsx"
                                       class="form-control settings-input" style="max-width:200px;padding:5px 8px;font-size:var(--text-xs)" />
                                <button form="barcodePoolImportForm" type="submit" class="settings-action-btn btn-save" style="padding:5px 12px;font-size:var(--text-xs)">
                                    <i class="fas fa-upload"></i> Aktar
                                </button>
                            </div>
                        </div>
                    </div>

                    @* Dışa Aktar *@
                    <div class="settings-section">
                        <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
                            <div>
                                <div class="settings-section-title">
                                    <i class="fas fa-download me-1" style="color:var(--color-primary)"></i>Barkod Dışa Aktar
                                </div>
                                <div class="settings-section-desc">Havuzu CSV / Excel olarak dışa aktarın</div>
                            </div>
                            <div class="d-flex align-items-center gap-2 flex-wrap">
                                <select form="barcodePoolExportForm" name="scope" class="form-select settings-input" style="max-width:130px;padding:5px 8px;font-size:var(--text-xs)">
                                    <option value="Remaining" selected>Kalan</option>
                                    <option value="All">Tümü</option>
                                    <option value="Snapshot">Snapshot</option>
                                </select>
                                <select form="barcodePoolExportForm" name="format" class="form-select settings-input" style="max-width:80px;padding:5px 8px;font-size:var(--text-xs)">
                                    <option value="csv" selected>CSV</option>
                                    <option value="xlsx">Excel</option>
                                </select>
                                <div class="form-check form-check-inline mb-0">
                                    <input form="barcodePoolExportForm" class="form-check-input" type="checkbox" name="pttFormat" value="true" id="pttFormatExport" checked />
                                    <label class="form-check-label" style="font-size:var(--text-xs)" for="pttFormatExport">PTT</label>
                                </div>
                                <button form="barcodePoolExportForm" type="submit" class="settings-action-btn btn-reset" style="padding:5px 12px;font-size:var(--text-xs)">
                                    <i class="fas fa-file-export"></i> Aktar
                                </button>
                            </div>
                        </div>
                    </div>

                    @* Barkod Numaralandırma (partial) *@
                    @await Html.PartialAsync("_BarcodeSettingsPartial", Model)
                </div>
            </div>
        </div>

        @* ── SAĞ: Etiket & Sayfa Ayarları ── *@
        <div class="col-lg-6">
            <div class="settings-card h-100">
                <div class="settings-card-header">
                    <div class="settings-card-icon icon-warning">
                        <i class="fas fa-th-large"></i>
                    </div>
                    <div>
                        <h5 class="settings-card-title">Etiket & Sayfa Ayarları (v2)</h5>
                        <p class="settings-card-desc">A4 / A5 etiket grid yapısı, satır/sütun ve boşluk ayarları.</p>
                    </div>
                </div>
                <div class="settings-card-body">
                    <div id="label-settings-container">
                        @await Html.PartialAsync("_LabelSettingsV2Partial", Model.LabelSettingsV2, labelSettingsViewData)
                    </div>
                </div>
            </div>
        </div>
    </div>

    @* ══════════════════════════════════════════════════════════
       SATIR 2 — iki orta kart: Dosya/Gönderen | Barkod Havuzu
       ══════════════════════════════════════════════════════════ *@
    <div class="row g-4 mb-4">
        @* ── SOL: Dosya ve Gönderen ── *@
        <div class="col-lg-6">
            <div class="settings-card h-100">
                <div class="settings-card-header">
                    <div class="settings-card-icon icon-primary">
                        <i class="fas fa-folder-open"></i>
                    </div>
                    <div>
                        <h5 class="settings-card-title">Dosya ve Gönderen Ayarları</h5>
                        <p class="settings-card-desc">PDF çıktı klasörleri ve varsayılan gönderen bilgisi.</p>
                    </div>
                </div>
                <div class="settings-card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label asp-for="PdfOutputPath" class="settings-label">
                                <i class="fas fa-save me-1"></i>PDF Çıktı Klasörü *
                            </label>
                            <input asp-for="PdfOutputPath" class="form-control settings-input" required
                                   placeholder="D:\TasraPostaManagerOutput" />
                            <div class="invalid-feedback">PDF çıktı klasörü zorunludur.</div>
                        </div>

                        <div class="col-md-6">
                            <label asp-for="PdfExternalPath" class="settings-label">
                                <i class="fas fa-hdd me-1"></i>Harici PDF Klasörü
                            </label>
                            <input asp-for="PdfExternalPath" class="form-control settings-input"
                                   placeholder="D:\HariciPDFKlasor" />
                            <small class="settings-help">
                                @if (Model.IsExternalPathAvailable)
                                {
                                    <span style="color:var(--color-success)"><i class="fas fa-check-circle me-1"></i>Erişilebilir</span>
                                }
                                else if (!string.IsNullOrWhiteSpace(Model.PdfExternalPath))
                                {
                                    <span style="color:var(--color-danger)"><i class="fas fa-exclamation-triangle me-1"></i>Erişilemiyor</span>
                                }
                            </small>
                        </div>

                        <div class="col-md-6">
                            <label asp-for="DefaultPaperSize" class="settings-label">
                                <i class="fas fa-file me-1"></i>Varsayılan Kağıt Boyutu *
                            </label>
                            <select asp-for="DefaultPaperSize" class="form-select settings-input" required>
                                <option value="A4">A4 (210 × 297 mm)</option>
                                <option value="A5">A5 (148 × 210 mm)</option>
                            </select>
                        </div>

                        <div class="col-md-6">
                            <label asp-for="DefaultGonderen" class="settings-label">
                                <i class="fas fa-user me-1"></i>Varsayılan Gönderen *
                            </label>
                            <textarea asp-for="DefaultGonderen" class="form-control settings-input"
                                      rows="3" required id="DefaultGonderen"
                                      placeholder="TAŞRA BELEDİYESİ&#x0a;YAZI İŞLERİ MÜDÜRLÜĞÜ"></textarea>
                            <div class="invalid-feedback">Gönderen bilgisi zorunludur.</div>
                        </div>

                        <div class="col-12">
                            <div class="sender-preview-box">
                                <div class="sender-preview-label"><i class="fas fa-eye"></i> <span>Etiket Üzerindeki Görünüm</span></div>
                                <div class="sender-preview-content" id="defaultSenderPreviewText"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        @* ── SAĞ: Barkod Havuzu Yönetimi ── *@
        <div class="col-lg-6">
            <div class="settings-card h-100">
                <div class="settings-card-header">
                    <div class="settings-card-icon icon-success">
                        <i class="fas fa-chart-bar"></i>
                    </div>
                    <div>
                        <h5 class="settings-card-title">Barkod Havuzu Yönetimi</h5>
                        <p class="settings-card-desc">Havuz kullanım durumu ve işlemleri.</p>
                    </div>
                </div>
                <div class="settings-card-body">
                    @if (Model.BarcodePoolStats != null)
                    {
                        var stats = Model.BarcodePoolStats;
                        var usedPct = stats.Total > 0 ? (double)stats.Used / stats.Total * 100 : 0;
                        var availPct = stats.Total > 0 ? (double)stats.Available / stats.Total * 100 : 0;
                        var disabledPct = stats.Total > 0 ? (double)stats.Disabled / stats.Total * 100 : 0;
                        var barColorClass = availPct > 50 ? "bar-available" : availPct > 20 ? "bar-warning" : "bar-danger";

                        @* İlerleme Çubuğu *@
                        <div class="mb-4">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="pool-stat-label">HAVUZ KULLANIMI</span>
                                <span style="font-size:var(--text-sm);font-weight:700;color:var(--text-primary)">
                                    @stats.Available.ToString("N0") / @stats.Total.ToString("N0") kalan
                                </span>
                            </div>
                            <div class="pool-progress">
                                <div class="d-flex" style="height:100%">
                                    <div class="pool-progress-bar bar-used"
                                         style="width:@usedPct.ToString("F1", System.Globalization.CultureInfo.InvariantCulture)%"
                                         data-bs-toggle="tooltip" title="Kullanılan: @stats.Used.ToString("N0")"></div>
                                    <div class="pool-progress-bar @barColorClass"
                                         style="width:@availPct.ToString("F1", System.Globalization.CultureInfo.InvariantCulture)%"
                                         data-bs-toggle="tooltip" title="Kalan: @stats.Available.ToString("N0")"></div>
                                    @if (stats.Disabled > 0)
                                    {
                                        <div class="pool-progress-bar bar-warning"
                                             style="width:@disabledPct.ToString("F1", System.Globalization.CultureInfo.InvariantCulture)%"
                                             data-bs-toggle="tooltip" title="Pasif: @stats.Disabled.ToString("N0")"></div>
                                    }
                                </div>
                            </div>
                        </div>

                        @* İstatistik Kartları *@
                        <div class="row g-2 mb-4">
                            <div class="col">
                                <div class="pool-stat accent-primary">
                                    <div class="pool-stat-value text-primary">@stats.Total.ToString("N0")</div>
                                    <div class="pool-stat-label">Toplam</div>
                                </div>
                            </div>
                            <div class="col">
                                <div class="pool-stat accent-success">
                                    <div class="pool-stat-value text-success">@stats.Available.ToString("N0")</div>
                                    <div class="pool-stat-label">Kalan</div>
                                </div>
                            </div>
                            <div class="col">
                                <div class="pool-stat accent-secondary">
                                    <div class="pool-stat-value text-secondary">@stats.Used.ToString("N0")</div>
                                    <div class="pool-stat-label">Kullanılan</div>
                                </div>
                            </div>
                            <div class="col">
                                <div class="pool-stat accent-warning">
                                    <div class="pool-stat-value text-warning">@stats.Disabled.ToString("N0")</div>
                                    <div class="pool-stat-label">Pasif</div>
                                </div>
                            </div>
                            <div class="col">
                                <div class="pool-stat accent-info">
                                    <div class="pool-stat-value text-info">@stats.UsedToday.ToString("N0")</div>
                                    <div class="pool-stat-label">Bugün</div>
                                </div>
                            </div>
                        </div>

                        @* Uyarı *@
                        @if (string.Equals(Model.DefaultBarcodeMode, "Pool", StringComparison.OrdinalIgnoreCase) && stats.Available < Model.BarcodePoolLowThreshold)
                        {
                            <div class="alert alert-danger py-2 mb-3 settings-alert">
                                <i class="fas fa-exclamation-circle me-2"></i>
                                <strong>Uyarı:</strong> Kalan barkod — <strong>@stats.Available.ToString("N0")</strong> (eşik: @Model.BarcodePoolLowThreshold.ToString("N0"))
                            </div>
                        }

                        @* Havuz İşlemleri *@
                        <div class="pool-actions">
                            <div class="settings-section-title mb-2"><i class="fas fa-tools me-1" style="color:var(--text-muted)"></i>Havuz İşlemleri</div>
                            <div class="d-flex flex-wrap gap-2">
                                <button form="barcodePoolExportForm" type="submit" class="settings-action-btn btn-reset" style="font-size:var(--text-xs)"
                                        onclick="document.querySelector('[name=scope]').value='Remaining';document.querySelector('[name=format]').value='xlsx'">
                                    <i class="fas fa-download"></i> Kalanları Yedekle
                                </button>
                                <button form="barcodePoolExportForm" type="submit" class="settings-action-btn btn-reset" style="font-size:var(--text-xs)"
                                        onclick="document.querySelector('[name=scope]').value='All';document.querySelector('[name=format]').value='xlsx'">
                                    <i class="fas fa-file-archive"></i> Tümünü Yedekle
                                </button>
                                <button form="barcodePoolResetForm" type="submit" class="settings-action-btn btn-danger" style="font-size:var(--text-xs)"
                                        onclick="return confirm('⚠️ DİKKAT: Tüm barkod havuzu temizlenecektir!\n\nBu işlem geri alınamaz.\nDevam etmeden önce kalanları yedeklemeniz önerilir.\n\nDevam etmek istiyor musunuz?');">
                                    <i class="fas fa-trash-alt"></i> Havuzu Sıfırla
                                </button>
                            </div>
                        </div>
                    }
                    else
                    {
                        <div class="text-center py-4">
                            <div style="width:56px;height:56px;border-radius:var(--radius-full);background:var(--color-primary-50);display:flex;align-items:center;justify-content:center;margin:0 auto var(--space-3);color:var(--color-primary);font-size:1.4rem">
                                <i class="fas fa-database"></i>
                            </div>
                            <p style="font-size:var(--text-sm);color:var(--text-muted);margin:0">
                                Barkod havuzu henüz oluşturulmamış.<br>
                                <small>Barkod Ayarları kartından .xlsx yükleyin.</small>
                            </p>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    @* ══════════════════════════════════════════════════════════
       AKSİYON BARI
       ══════════════════════════════════════════════════════════ *@
    <div class="settings-action-bar">
        <div class="d-flex gap-2 flex-wrap">
            <button type="submit" class="settings-action-btn btn-save">
                <i class="fas fa-save"></i> Ayarları Kaydet
            </button>
            <button type="button" class="settings-action-btn btn-reset" onclick="resetBarcodeSettings()">
                <i class="fas fa-undo"></i> Barkod Sıfırla
            </button>
            <button type="button" class="settings-action-btn btn-danger" onclick="resetAllSettings()">
                <i class="fas fa-bomb"></i> Tüm Ayarları Sıfırla
            </button>
        </div>
        <button type="button" class="settings-action-btn btn-test" onclick="testBarcodeGeneration()">
            <i class="fas fa-vial"></i> Barkod Testi Yap
        </button>
    </div>
</form>

@* ══════════════════════════════════════════════════════════
   SATIR 3 — Veritabanı Yedekleme (tam genişlik, ana form DIŞINDA)
   ══════════════════════════════════════════════════════════ *@
<div class="row g-4 mb-4">
    <div class="col-12">
        <div class="settings-card">
            <div class="settings-card-header">
                <div class="settings-card-icon icon-info">
                    <i class="fas fa-database"></i>
                </div>
                <div class="flex-grow-1">
                    <h5 class="settings-card-title">Veritabanı Yedekleme</h5>
                    <p class="settings-card-desc">SQL Server veritabanınızı yedekleyin, indirin veya silin.</p>
                </div>
                <form asp-action="BackupDatabase" asp-controller="Settings" method="post" class="d-inline">
                    @Html.AntiForgeryToken()
                    <button type="submit" class="settings-action-btn btn-save" id="btnCreateBackup" style="padding:8px 16px">
                        <i class="fas fa-plus"></i> Yeni Yedek Oluştur
                    </button>
                </form>
            </div>
            <div class="settings-card-body" style="padding:0">
                <div id="backupListContainer">
                    <div class="text-center py-4">
                        <div class="spinner-border spinner-border-sm me-2" style="color:var(--color-primary)"></div>
                        <span style="font-size:var(--text-sm);color:var(--text-muted)">Yedekler yükleniyor...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@* Pool Import/Export/Reset formları (nested-form olmasın diye ayrı) *@
<form id="barcodePoolImportForm" asp-action="ImportBarcodePool" asp-controller="Settings" method="post" enctype="multipart/form-data" class="d-none">
    @Html.AntiForgeryToken()
</form>
<form id="barcodePoolExportForm" asp-action="ExportBarcodePool" asp-controller="Settings" method="post" class="d-none">
    @Html.AntiForgeryToken()
</form>
<form id="barcodePoolResetForm" asp-action="ResetBarcodePool" asp-controller="Settings" method="post" class="d-none">
    @Html.AntiForgeryToken()
</form>

@section Scripts {
    <script>
        // ═══════════ BARKOD ═══════════
        async function testBarcodeGeneration() {
            try {
                const r = await fetch('@Url.Action("TestBarcodeGeneration", "Settings")', {
                    method: 'POST',
                    headers: { 'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value }
                });
                const d = await r.json();
                if (d.success) showAlert('success', `Test Başarılı! Barkod: <strong>${d.barcode}</strong> — Kalan: ${d.remainingCount}`);
                else showAlert('danger', d.message || 'Barkod testi başarısız oldu.');
            } catch (e) { showAlert('danger', 'Barkod testi sırasında bir hata oluştu.'); }
        }

        async function resetBarcodeSettings() {
            if (!confirm('Barkod ayarlarını varsayılan değerlere sıfırlamak istediğinizden emin misiniz?')) return;
            try {
                const r = await fetch('@Url.Action("ResetBarcodeSettings", "Settings")', {
                    method: 'POST',
                    headers: { 'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value }
                });
                if (r.ok) location.reload(); else showAlert('danger', 'Sıfırlama başarısız.');
            } catch (e) { showAlert('danger', 'Sıfırlama hatası.'); }
        }

        async function resetAllSettings() {
            if (!confirm('TÜM ayarları sıfırlamak istediğinizden emin misiniz?\n\nBu işlem geri alınamaz!')) return;
            try {
                const r = await fetch('@Url.Action("ResetAllSettings", "Settings")', {
                    method: 'POST',
                    headers: { 'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value }
                });
                if (r.ok) location.reload(); else showAlert('danger', 'Sıfırlama başarısız.');
            } catch (e) { showAlert('danger', 'Sıfırlama hatası.'); }
        }

        // ═══════════ ÖNİZLEME ═══════════
        function updateBarcodePreview() {
            const prefix = document.querySelector('[name="BarcodePrefix"]')?.value || '';
            let startNum = document.querySelector('[name="BarcodeStartNumber"]')?.value || '';
            const digits = parseInt(document.querySelector('[name="BarcodeDigitCount"]')?.value || '0');
            const suffix = document.querySelector('[name="BarcodeSuffix"]')?.value || '';
            startNum = startNum.replace(/\D/g, '');
            if (digits > 0 && startNum.length > digits) { startNum = startNum.substring(0, digits); document.querySelector('[name="BarcodeStartNumber"]').value = startNum; }
            const numPart = startNum.padEnd(digits, '0');
            const barcode = prefix + numPart + suffix;
            const el = document.getElementById('barcodePreview');
            const le = document.getElementById('previewLength');
            if (el) el.textContent = barcode;
            if (le) le.textContent = prefix.length + digits + suffix.length;
        }

        function updateSenderPreview() {
            const ta = document.getElementById('DefaultGonderen');
            const prev = document.getElementById('defaultSenderPreviewText');
            if (!ta || !prev) return;
            const raw = ta.value?.trim().length > 0 ? ta.value : 'Taşra Belediyesi';
            prev.innerHTML = '';
            raw.split(/\r?\n/).forEach(l => { const d = document.createElement('div'); d.textContent = l; prev.appendChild(d); });
        }

        function updateLabelPreview() {
            const ps = document.querySelector('[name="LabelSettingsV2.PaperSize"]');
            const or = document.querySelector('[name="LabelSettingsV2.Orientation"]');
            const tp = document.querySelector('[name="LabelSettingsV2.Template"]');
            if (!ps || !or || !tp) return;
            const el = document.getElementById('labelSettingsSummary');
            if (el) el.textContent = `${ps.value} - ${or.value} - ${tp.value}`;
        }

        async function handleTemplateChange() {
            const sel = document.getElementById('labelTemplateSelect');
            if (!sel) return;
            const val = sel.value, cur = sel.getAttribute('data-current-template');
            if (!val || val === cur) { updateLabelPreview(); return; }
            const cont = document.getElementById('label-settings-container');
            if (cont) cont.style.opacity = '0.5';
            try {
                const r = await fetch('@Url.Action("OnLabelTemplateChanged", "Settings")', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value },
                    body: JSON.stringify({ NewTemplate: val, PreviousTemplate: cur })
                });
                if (!r.ok) throw new Error(r.status);
                const html = await r.text();
                if (cont) { cont.innerHTML = html; cont.style.opacity = '1'; }
                sel.setAttribute('data-current-template', val);
                updateLabelPreview();
            } catch (e) { showAlert('danger', 'Şablon hatası: ' + e.message); if (cont) cont.style.opacity = '1'; }
        }

        // ═══════════ YARDIMCI ═══════════
        function showAlert(type, msg) {
            const ph = document.getElementById('alertPlaceholder');
            if (!ph) return;
            const w = document.createElement('div');
            w.innerHTML = `<div class="alert alert-${type} alert-dismissible fade show settings-alert" role="alert">${msg}<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>`;
            ph.append(w);
        }

        // ═══════════ SAYFA YÜKLEME ═══════════
        document.addEventListener('DOMContentLoaded', function () {
            const form = document.getElementById('settingsForm');
            const sender = document.getElementById('DefaultGonderen');
            if (sender) { sender.addEventListener('input', updateSenderPreview); updateSenderPreview(); }

            document.querySelectorAll('[name="BarcodePrefix"],[name="BarcodeStartNumber"],[name="BarcodeDigitCount"],[name="BarcodeSuffix"]')
                .forEach(i => i.addEventListener('input', updateBarcodePreview));

            document.body.addEventListener('change', e => { if (e.target?.id === 'labelTemplateSelect') handleTemplateChange(); });

            updateBarcodePreview();
            updateLabelPreview();

            if (form) {
                form.addEventListener('submit', function (e) {
                    // Önceki uyarıyı temizle
                    const oldAlert = form.querySelector('.validation-alert');
                    if (oldAlert) oldAlert.remove();

                    if (!form.checkValidity()) {
                        e.preventDefault();
                        e.stopPropagation();
                        // Geçersiz alana scroll et ve kullanıcıya bildir
                        const firstInvalid = form.querySelector(':invalid');
                        let msg = 'Formda geçersiz alanlar var, lütfen kontrol edin.';
                        if (firstInvalid) {
                            firstInvalid.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            firstInvalid.focus();
                            const label = firstInvalid.closest('.col-md-6,.col-md-3,.col-12,.col,.mb-3')?.querySelector('label');
                            const fieldName = label?.textContent?.trim() || firstInvalid.name || 'Bilinmeyen alan';
                            msg = `Lütfen zorunlu alanları doldurun: <strong>${fieldName}</strong>`;
                        }
                        const alertDiv = document.createElement('div');
                        alertDiv.className = 'alert alert-warning alert-dismissible fade show validation-alert';
                        alertDiv.setAttribute('role', 'alert');
                        alertDiv.innerHTML = `<i class="fas fa-exclamation-triangle me-1"></i> ${msg} <button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
                        form.insertBefore(alertDiv, form.firstChild);
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    }
                    form.classList.add('was-validated');
                });
                form.querySelectorAll('input[required],textarea[required],select[required]').forEach(i => {
                    i.addEventListener('input', function () { this.classList.toggle('is-invalid', !this.checkValidity()); });
                });
            }
        });

        // ═══════════ VERİTABANI YEDEKLEME ═══════════
        async function loadBackupList() {
            const c = document.getElementById('backupListContainer');
            if (!c) return;
            try {
                const r = await fetch('/Settings/GetBackups');
                const backups = await r.json();
                if (backups.length === 0) {
                    c.innerHTML = '<div class="text-center py-4" style="color:var(--text-muted)"><i class="fas fa-archive fa-2x mb-2" style="opacity:.3;display:block"></i><span style="font-size:var(--text-sm)">Henüz yedek dosyası bulunmuyor.</span></div>';
                    return;
                }
                let h = '';
                backups.forEach(b => {
                    h += `<div class="backup-item">
                        <div class="d-flex align-items-center gap-3">
                            <div class="backup-item-icon"><i class="fas fa-file-archive"></i></div>
                            <div><div class="backup-item-name">${b.fileName}</div><div class="backup-item-meta">${b.createdAt} · ${b.sizeDisplay}</div></div>
                        </div>
                        <div class="d-flex gap-1">
                            <a href="/Settings/DownloadBackup?fileName=${encodeURIComponent(b.fileName)}" class="settings-action-btn btn-reset" style="padding:4px 10px;font-size:var(--text-xs)" title="İndir"><i class="fas fa-download"></i></a>
                            <button type="button" class="settings-action-btn btn-danger" style="padding:4px 10px;font-size:var(--text-xs)" title="Sil" onclick="deleteBackup('${b.fileName}')"><i class="fas fa-trash-alt"></i></button>
                        </div></div>`;
                });
                c.innerHTML = h;
            } catch (e) { c.innerHTML = '<div class="text-center py-3" style="color:var(--color-warning)"><i class="fas fa-exclamation-triangle me-1"></i><span style="font-size:var(--text-sm)">Yedek listesi yüklenirken hata.</span></div>'; }
        }

        async function deleteBackup(fn) {
            if (!confirm(`"${fn}" silinsin mi?\n\nBu işlem geri alınamaz.`)) return;
            try {
                const fd = new FormData();
                fd.append('fileName', fn);
                fd.append('__RequestVerificationToken', document.querySelector('input[name="__RequestVerificationToken"]')?.value);
                const r = await fetch('/Settings/DeleteBackup', { method: 'POST', body: fd });
                if (r.redirected) window.location.href = r.url;
                else { loadBackupList(); showAlert('success', `Silindi: <strong>${fn}</strong>`); }
            } catch (e) { showAlert('danger', 'Yedek silinirken hata.'); }
        }

        const backupBtn = document.getElementById('btnCreateBackup');
        if (backupBtn) {
            backupBtn.closest('form').addEventListener('submit', function () {
                backupBtn.disabled = true;
                backupBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Yedekleniyor...';
            });
        }

        loadBackupList();

        @if (TempData["AutoDownloadBackup"] is string autoDownloadFile && !string.IsNullOrEmpty(autoDownloadFile))
        {
            <text>
            (function() {
                const iframe = document.createElement('iframe');
                iframe.style.display = 'none';
                iframe.src = '/Settings/DownloadBackup?fileName=' + encodeURIComponent('@Html.Raw(autoDownloadFile)');
                document.body.appendChild(iframe);
                setTimeout(() => iframe.remove(), 30000);
            })();
            </text>
        }
    </script>
}
